
# Management Cluster in a single-node setup

This is an example of using Edge Image Builder (EIB) to generate a management cluster iso image for SUSE Telco Cloud. The management cluster will contain the following components:
- SUSE Linux Micro 6.1 Kernel (SL Micro 6.1)
- RKE2
- CNI plugins (e.g. Multus, Cilium)
- Rancher Prime
- Neuvector
- Longhorn
- Static IPs or DHCP network configuration
- Metal3 and the CAPI provider (if you want to add support for aarch64 architecture, the changes will be explained in `Optional modifications` section of this document)

In this example the above components will be configured to operate with both IPv4 and IPv6, however Metal3, and Ironic in particular, can be configured in different ways, depending on your infrastructure or requirements:
- the Ironic services can be set to listen on all the interfaces on the system (on by default), thus if the server is configured to assign both an IPv4 and IPv6 address to the relevant interface any of two IPs can be used by BMHs during the provisioning. Note that at this time only one of these addresses can be selected for the URL generation (for consumption by other services, e.g. the Baremetal Operator); however, if the BMH definitions specifies a an IPv6 address, the Ironic IPv6 will be selected for the communication during the provisioning. More details in the following sections.
- a single hostname, resolving to both IPv4 and IPv6, can be used by Metal3 to let Ironic use those addresses for binding and URL creation. This approach allows for an easy configuration, but requires an infrastructure with preexisting DNS servers, IP allocations and records already in place.

In both cases, Kubernetes will need to be instructed with CIDRs for both IPv4 and IPv6.

The following sections will explain how to configure the EIB files according to the former case, assuming `${MGMT_CLUSTER_IP_V4}` to be an IPv4 address, for URL generation.

You need to modify the following values in the `mgmt-cluster-singlenode.yaml` file:

- `${ROOT_PASSWORD}` - The root password for the management cluster. This could be generated using `openssl passwd -6 PASSWORD` and replacing PASSWORD with the desired password, and then replacing the value in the `mgmt-cluster-singlenode.yaml` file. The final rancher password will be configured based on the file `custom/files/basic-setup.sh`.
- `${SCC_REGISTRATION_CODE}` - The registration code for the SUSE Customer Center for the SLE Micro product. This could be obtained from the SUSE Customer Center and replacing the value in the `mgmt-cluster-singlenode.yaml` file.

You need to modify the following values in the `network/mgmt-cluster-network.yaml` file, enabling the managment node to operate in dual-stack mode:

- `${MGMT_GATEWAY_V4}` - the IPv4 address of the gateway for the traffic matching the default route
- `${MGMT_GATEWAY_V6}` - the IPv6 address of the gateway for the traffic matching the default route
- `${MGMT_DNS}` - the DNS IP of your management cluster network
- `${MGMT_CLUSTER_IP_V4}` - the static IPv6 address assigned to the single node of the management cluster
- `${MGMT_CLUSTER_IP_V6}` - the static IPv6 address assigned to the single node of the management cluster
- `${MGMT_MAC}` - the MAC address of your management cluster node

You also need to modify the following files:

- `kubernetes/helm/values/metal3.yaml` - replacing `${MGMT_CLUSTER_IP_V4}` and `${MGMT_CLUSTER_IP_V6}` with the node IPv4 and IPv6 addresses, respectively

- `kubernetes/helm/values/rancher.yaml` - replacing `${MGMT_CLUSTER_IP_V4}`

You need to modify the following values in the `custom/scripts/99-register.sh` file:

- `${SCC_REGISTRATION_CODE}` - The registration code for the SUSE Customer Center for the SL Micro product. This could be obtained from the SUSE Customer Center and replacing the value in the `99-register.sh` file.

- `${SCC_ACCOUNT_EMAIL}` - The email address for the SUSE Customer Center account. This could be obtained from the SUSE Customer Center and replacing the value in the `99-register.sh` file.

You need to modify the following folder:

- `base-images` - To include the raw image generated by Kiwi as:

```
mkdir output
sudo podman run --privileged -v /etc/zypp/repos.d:/micro-sdk/repos/ -v $(pwd)/output:/tmp/output -it registry.suse.com/edge/3.4/kiwi-builder:10.2.12.0 build-image -p Default-SelfInstall
```

The resulting iso image needs to be copied over to the `base-image` folder and used as a reference in the `eib/telco-edge-cluster.yaml` file:

``` 
cp $(pwd)/output/*.iso base-images/
```

> **_Note:_** For more information about this process you can follow the [full guide instructions in official docs](https://documentation.suse.com/suse-edge/3.4/html/edge/guides-kiwi-builder-images.html)


## Optional modifications

### Add certificates to use HTTPS server to provide images using TLS

This is an optional step to add certificates to the management cluster to provide images using HTTPS Server (Helm Chart metal3 Version >= 0.7.1)

1. Modify the `kubernetes/helm/values/metal3.yaml` file to set to true the following value in the global section:

```yaml
global:
  additionalTrustedCAs: true
```

2. If you are deploying a mgmt-cluster from scratch using EIB, then add the secret to the manifests folder `kubernetes/manifests/metal3-cacert-secret.yaml` to automate the creation of the secret in the management cluster:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: metal3-system
---
apiVersion: v1
kind: Secret
metadata:
  name: tls-ca-additional
  namespace: metal3-system
type: Opaque
data:
  ca-additional.crt: {{ additional_ca_cert | b64encode }}
```

3. Alternatively, you can use the following command to create the secret manually:

```bash
kubectl -n meta3-system create secret generic tls-ca-additional --from-file=ca-additional.crt=./ca-additional.crt
```

where `ca-additional.crt` is the certificate file that you want to use to provide images using HTTPS.

## Building the Management Cluster Image using EIB

1. Clone this repo and navigate to the `telco-examples/mgmt-cluster/single-node/eib` directory.

```bash
$ git clone https://github.com/suse-edge/telco-cloud-examples.git
$ cd telco-examples/mgmt-cluster/single-node/eib
```

2. Modify the files described above.

3. Run the image building process.

```bash
$ sudo podman run --rm --privileged -it -v $PWD:/eib \
registry.suse.com/edge/3.4/edge-image-builder:1.3.0 \
build --definition-file mgmt-cluster-singlenode.yaml
```

## Deploy the Management Cluster

Once the build process is finished, you will find the modified ISO image in the `eib` directory. You can then proceed to provision a VM or a baremetal server with it.

## Metal3 configured through hostnames resolving to both IPv4 and IPv6 addresses

As already mentioned, it is possible to leverage an existing internal DNS infrastructure to define a name based URL which can work with both IPv4 and IPv6 capable BMCs, allowing downstream clusters to operate with servers with mixed support. This approach is however mutually exclusive with the one shown above and, thus, requires a different set of values in file `kubernetes/helm/values/metal3.yaml`:

```yaml
global:
  provisioningHostname: ${MGMT_CLUSTER_HOSTNAME}
  enable_vmedia_tls: false
  additionalTrustedCAs: false
metal3-ironic:
  global:
    predictableNicNames: true
  persistence:
    ironic:
      size: "5Gi"
  service:
    type: NodePort
```

where `$MGMT_CLUSTER_HOSTNAME` must be replaced with a fully qualified domain name.

Note that some older BMCs might not support hostname based URLs for VirtualMedia booting, make to check for proper support before proceeding.
